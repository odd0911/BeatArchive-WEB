<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>로컬 음원 + 노트 하강 예제</title>
<style>
  body {
    background: #111;
    color: white;
    font-family: sans-serif;
    text-align: center;
    margin: 0; padding: 0;
  }
  #gameArea {
    position: relative;
    margin: 20px auto;
    width: 400px; height: 600px;
    background: #222;
    border: 2px solid #555;
    overflow: hidden;
  }
  .lane {
    position: absolute;
    bottom: 0;
    width: 25%;
    height: 100%;
    border-left: 1px solid #444;
    box-sizing: border-box;
  }
  .lane:nth-child(1) { left: 0; }
  .lane:nth-child(2) { left: 25%; }
  .lane:nth-child(3) { left: 50%; }
  .lane:nth-child(4) { left: 75%; border-right: 1px solid #444;}
  
  .note {
    position: absolute;
    width: 80%;
    left: 10%;
    background: #0af;
    border-radius: 8px;
    box-shadow: 0 0 10px #0af;
  }
  #fileInput {
    margin: 10px auto;
  }
</style>
</head>
<body>

<h1>로컬 음원 + 노트 하강</h1>
<input type="file" id="fileInput" accept=".csv" />
<br/>
<input type="file" id="audioInput" accept="audio/*" />
<div id="gameArea">
  <div class="lane"></div>
  <div class="lane"></div>
  <div class="lane"></div>
  <div class="lane"></div>
</div>

<audio id="audio" controls></audio>

<script>
  const gameArea = document.getElementById('gameArea');
  const fileInput = document.getElementById('fileInput');
  const audioInput = document.getElementById('audioInput');
  const audio = document.getElementById('audio');

  const lanesCount = 4;
  const gameHeight = 600;
  const totalFallTime = 2500;
  const noteHeightDefault = 30;

  let notes = [];
  let animationId = null;
  let startTime = null;
  let fallingStarted = false;

  fileInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      parseCSV(ev.target.result);
      resetNotes();
    };
    reader.readAsText(file);
  });

  audioInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const url = URL.createObjectURL(file);
    audio.src = url;
  });

  function parseCSV(text) {
    notes = [];
    const lines = text.trim().split('\n');
    for (const line of lines) {
      const [timeStr, laneStr, typeStr, holdStr] = line.split(',').map(s => s.trim());
      const time = parseInt(timeStr);
      const lane = parseInt(laneStr);
      const type = parseInt(typeStr);
      const hold = parseInt(holdStr) || 0;
      if (lane < 0 || lane >= lanesCount) continue;
      notes.push({time, lane, type, hold, domElement: null});
    }
  }

  function resetNotes() {
    while(gameArea.firstChild) gameArea.removeChild(gameArea.firstChild);
    for(let i=0; i<lanesCount; i++) {
      const laneDiv = document.createElement('div');
      laneDiv.classList.add('lane');
      gameArea.appendChild(laneDiv);
    }
    for (const note of notes) {
      const noteEl = document.createElement('div');
      noteEl.classList.add('note');
      noteEl.style.height = noteHeightDefault + 'px';
      noteEl.style.bottom = gameHeight + 'px';
      const laneWidth = gameArea.clientWidth / lanesCount;
      noteEl.style.left = laneWidth * note.lane + laneWidth*0.1 + 'px';
      noteEl.style.width = laneWidth*0.8 + 'px';
      note.domElement = noteEl;
      gameArea.appendChild(noteEl);
    }
  }

  function animationLoop() {
    if (!fallingStarted) return;

    const now = performance.now();
    const elapsed = now - startTime;
    const noteSpeed = gameHeight / totalFallTime;

    for (const note of notes) {
      if (!note.domElement) continue;
      const pos = gameHeight - elapsed * noteSpeed;
      note.domElement.style.bottom = (pos < 0 ? 0 : pos) + 'px';
    }

    if (elapsed >= totalFallTime) {
      fallingStarted = false;
      cancelAnimationFrame(animationId);
      animationId = null;
      return;
    }

    animationId = requestAnimationFrame(animationLoop);
  }

  document.addEventListener('keydown', e => {
    if(e.code === 'Space') {
      if(fallingStarted) return;
      if(notes.length === 0) return;
      if(audio.paused) {
        setTimeout(() => {
          audio.play();
        }, 2500);
      }
      fallingStarted = true;
      startTime = performance.now();
      animationLoop();
    }
  });
</script>

</body>
</html>
